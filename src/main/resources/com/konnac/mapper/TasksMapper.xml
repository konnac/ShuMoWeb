<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.konnac.mapper.TasksMapper">

    <sql id="commonSelect">
        select t.id, t.project_id, p.name as project_name, t.title, t.description,
               t.assignee_id,
               u.real_name as assignee_name,
               t.estimated_hours, t.actual_hours, t.deadline, t.status,
               t.created_time, t.update_time
        from tasks t
        left join projects p on t.project_id = p.id
        left join users u on t.assignee_id = u.id
    </sql>

    <select id="getTaskById" resultType="com.konnac.pojo.Task">
        <include refid="commonSelect"></include>
        where t.id = #{id}
    </select>

<!--新增任务-->
    <insert id="addTask" useGeneratedKeys="true" keyProperty="id">
        insert into tasks(project_id, title, description, assignee_id, estimated_hours,
                          actual_hours, deadline, status, created_time, update_time)
        VALUES (#{projectId}, #{title}, #{description}, #{assigneeId}, #{estimatedHours},
                #{actualHours}, #{deadline}, #{status}, #{createdTime}, #{updateTime})
    </insert>
<!--修改任务信息-->
    <update id="updateTask">
        UPDATE tasks
        <set>
            <if test="projectId != null">
            project_id = #{projectId},
             </if>
            <if test="title != null">
                title = #{title},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="assigneeId != null">
                assignee_id = #{assigneeId},
            </if>
            <if test="estimatedHours != null">
                estimated_hours = #{estimatedHours},
            </if>
            <if test="actualHours != null">
                actual_hours = #{actualHours},
            </if>
            <if test="deadline != null">
                deadline = #{deadline},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id}
    </update>
<!--查询未完成的任务树-->
    <select id="getUncompletedTaskCountByProjectIdAndUserId" resultType="int">
        select count(*)
        from tasks t
        left join task_members tm on t.id = tm.task_id and tm.task_role = 'ASSIGNEE' and tm.status = 'ACTIVE'
        where t.project_id = #{projectId}
          and tm.user_id = #{userId}
          and t.status NOT IN ('COMPLETED', 'CANCELLED')
    </select>

    <!-- 分页查询（项目经理和普通员工：查看自己所在项目的任务） -->
    <select id="list" resultType="com.konnac.pojo.Task">
        select DISTINCT t.id, t.project_id, p.name as project_name, t.title, t.description,
               t.assignee_id,
               u.real_name as assignee_name,
               t.estimated_hours, t.actual_hours, t.deadline, t.status,
               t.created_time, t.update_time
        from tasks t
        left join projects p on t.project_id = p.id
        left join users u on t.assignee_id = u.id
        <where>
            <!-- 用户参与条件：用户是项目经理 或者 是项目成员 或者 是任务成员 -->
            <if test="currentUserId != null">
                AND (
                t.project_id IN (SELECT id FROM projects WHERE manager_id = #{currentUserId})
                OR EXISTS (
                    SELECT 1 FROM project_members pm 
                    WHERE pm.project_id = t.project_id 
                    AND pm.user_id = #{currentUserId} 
                    AND pm.status = 'ACTIVE'
                )
                OR EXISTS (
                    SELECT 1 FROM task_members tm 
                    WHERE tm.task_id = t.id 
                    AND tm.user_id = #{currentUserId} 
                    AND tm.status = 'ACTIVE'
                )
                )
            </if>
            <if test="projectId != null">
                and t.project_id = #{projectId}
            </if>
            <if test="Id != null">
                and t.id = #{Id}
            </if>
            <if test="title != null and title.trim() != ''">
                and t.title like concat('%', #{title}, '%')
            </if>
            <if test="assigneeName != null and assigneeName.trim() != ''">
                and t.id in (select tm.task_id from task_members tm
                             left join users u on tm.user_id = u.id
                             where tm.task_role = 'ASSIGNEE' and tm.status = 'ACTIVE'
                             and u.real_name like concat('%', #{assigneeName}, '%'))
            </if>
            <if test="status != null">
                and t.status = #{status}
            </if>
            <if test="status == null">
                and t.status != 'CANCELLED'
            </if>
            <choose>
                <when test="begin != null and end != null">
                    AND DATE(t.created_time) BETWEEN #{begin} AND #{end}
                </when>
                <when test="begin != null">
                    AND DATE(t.created_time) >= #{begin}
                </when>
                <when test="end != null">
                    AND #{end} >= DATE(t.created_time)
                </when>
            </choose>
        </where>
        ORDER BY t.created_time DESC
    </select>

    <!-- 分页查询所有任务（管理员） -->
    <select id="listAll" resultType="com.konnac.pojo.Task">
        <include refid="commonSelect"></include>
        <where>
            <if test="projectId != null">
                and t.project_id = #{projectId}
            </if>
            <if test="Id != null">
                and t.id = #{Id}
            </if>
            <if test="title != null and title.trim() != ''">
                and t.title like concat('%', #{title}, '%')
            </if>
            <if test="assigneeName != null and assigneeName.trim() != ''">
                and t.id in (select tm.task_id from task_members tm
                             left join users u on tm.user_id = u.id
                             where tm.task_role = 'ASSIGNEE' and tm.status = 'ACTIVE'
                             and u.real_name like concat('%', #{assigneeName}, '%'))
            </if>
            <if test="status != null">
                and t.status = #{status}
            </if>
            <choose>
                <when test="begin != null and end != null">
                    AND DATE(t.created_time) BETWEEN #{begin} AND #{end}
                </when>
                <when test="begin != null">
                    AND DATE(t.created_time) >= #{begin}
                </when>
                <when test="end != null">
                    AND #{end} >= DATE(t.created_time)
                </when>
            </choose>
        </where>
        ORDER BY t.created_time DESC
    </select>
<!--查询一个项目中未完成的任务数-->
    <select id="getUncompletedTaskCountByProjectId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM tasks
        WHERE project_id = #{projectId}
          AND status IN ('NOT_STARTED',
                         'IN_PROGRESS',
                         'DELAY')
    </select>

    <!--批量取消项目下的所有任务-->
    <update id="cancelTasksByProjectId">
        UPDATE tasks
        SET status = 'CANCELLED',
            update_time = NOW()
        WHERE project_id = #{projectId}
          AND status IN ('NOT_STARTED', 'IN_PROGRESS', 'DELAY')
    </update>

    <!-- 查询"我的任务" - 根据用户角色返回不同的任务列表 -->
    <select id="listMyTasks" resultType="com.konnac.pojo.Task">
        <include refid="commonSelect"></include>
        <where>
            <choose>
                <!-- 管理员：查看所有任务 -->
                <when test="userRole == 'ADMIN'">
                    <if test="projectId != null">
                        and t.project_id = #{projectId}
                    </if>
                </when>
                <!-- 项目经理：查看自己负责的项目下的所有任务 -->
                <when test="userRole == 'PROJECT_MANAGER'">
                    AND t.project_id IN (SELECT id FROM projects WHERE manager_id = #{currentUserId})
                    <if test="projectId != null">
                        and t.project_id = #{projectId}
                    </if>
                </when>
                <!-- 普通员工：查看自己作为负责人或协作者参与的任务 -->
                <otherwise>
                    AND t.id IN (SELECT tm.task_id FROM task_members tm WHERE tm.user_id = #{currentUserId} AND tm.status = 'ACTIVE')
                    <if test="projectId != null">
                        and t.project_id = #{projectId}
                    </if>
                </otherwise>
            </choose>
            <if test="Id != null">
                and t.id = #{Id}
            </if>
            <if test="title != null and title.trim() != ''">
                and t.title like concat('%', #{title}, '%')
            </if>
            <if test="assigneeName != null and assigneeName.trim() != ''">
                and t.id in (select tm.task_id from task_members tm
                             left join users u on tm.user_id = u.id
                             where tm.task_role = 'ASSIGNEE' and tm.status = 'ACTIVE'
                             and u.real_name like concat('%', #{assigneeName}, '%'))
            </if>
            <if test="status != null">
                and t.status = #{status}
            </if>
            <if test="status == null and userRole != 'ADMIN'">
                and t.status != 'CANCELLED'
            </if>
            <choose>
                <when test="begin != null and end != null">
                    AND DATE(t.created_time) BETWEEN #{begin} AND #{end}
                </when>
                <when test="begin != null">
                    AND DATE(t.created_time) >= #{begin}
                </when>
                <when test="end != null">
                    AND #{end} >= DATE(t.created_time)
                </when>
            </choose>
        </where>
        ORDER BY t.created_time DESC
    </select>
</mapper>